- ansible.builtin.import_tasks: kernels.yaml
  name: kernels

- name: Get boot device UUID
  ansible.builtin.shell: "blkid -s UUID -o value {{ root_device }}"
  register: root_uuid

- name: Get swap device UUID
  ansible.builtin.shell: 'cat /etc/fstab | grep swap | grep "UUID" | cut -f 1'
  register: swap_uuid

- name: Create /etc/cmdline.d directory
  ansible.builtin.file:
    path: /etc/cmdline.d
    state: directory
    mode: "0755"
  register: created_cmdline

- name: Populate kernel command line root file
  ansible.builtin.template:
    src: root.conf.j2
    dest: /etc/cmdline.d/root.conf
  notify:
    - Regenerate initramfs

- name: Populate kernel command line resume file
  ansible.builtin.template:
    src: resume.conf.j2
    dest: /etc/cmdline.d/resume.conf
  notify:
    - Regenerate initramfs

- name: Populate kernel command line plymouth file
  ansible.builtin.copy:
    src: plymouth.conf
    dest: /etc/cmdline.d
  notify:
    - Regenerate initramfs

- name: Populate kernel command line amd file
  ansible.builtin.copy:
    src: amd.conf
    dest: /etc/cmdline.d
  when: system.processor == "amd"
  notify:
    - Regenerate initramfs

- name: Populate kernel command line kernel file
  ansible.builtin.copy:
    src: kernel.conf
    dest: /etc/cmdline.d
  notify:
    - Regenerate initramfs

- name: Push mkinitcpio configuration and Regenerate initramfs
  ansible.builtin.template:
    src: mkinitcpio.conf.j2
    dest: /etc/mkinitcpio.conf.d/mkinitcpio-override.conf
  notify:
    - Regenerate initramfs

- name: Firmware
  community.general.pacman:
    name:
      - linux-firmware
      - sof-firmware
    state: present
  notify:
    - Regenerate initramfs
